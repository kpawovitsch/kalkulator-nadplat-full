<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalkulator nadp≈Çat kredytu</title>
  <style>
    :root { --bg:#0b0c10; --card:#14161a; --muted:#8892a6; --fg:#e9eef7; --accent:#7aa2f7; --ok:#67e8a5; --warn:#f6c84f; --bad:#ff6b6b; }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--fg);}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 18px}
    p.help{color:var(--muted);margin-top:4px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.07);border-radius:16px;padding:16px}
    .span-6{grid-column:span 6}
    .span-12{grid-column:span 12}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f1115;color:var(--fg)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#11141a;color:var(--fg);cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:#0b1220;font-weight:600}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .kpi{display:flex;gap:16px;flex-wrap:wrap}
    .kpi .tile{flex:1 1 220px;background:#0f1217;border:1px dashed rgba(255,255,255,.12);border-radius:14px;padding:14px}
    .kpi .tile b{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .kpi .tile .val{font-size:22px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:right}
    th{color:var(--muted);font-weight:600}
    td:first-child, th:first-child{text-align:center}
    .muted{color:var(--muted)}
    .note{font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .bad{color:var(--bad)}
    .hidden{display:none !important;}
    .mini-box{
      margin-top:10px;padding:10px 12px;border:1px solid rgba(255,255,255,.08);
      background:#0f1217;border-radius:10px;font-size:12px;color:var(--muted);line-height:1.35;
    }
    .mini-box .line{margin:2px 0}
    @media (max-width:900px){.span-6{grid-column:span 12}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üìâ Kalkulator nadp≈Çat kredytu</h1>
    <p class="help">
      Wpisz parametry oraz nadp≈Çaty. Zobaczysz, o ile szybciej sp≈Çacisz kredyt i ile odsetek zaoszczƒôdzisz.
      <span class="muted">To wersja publiczna ‚Äì pola startujƒÖ puste.</span>
    </p>

    <div class="grid">
      <div class="card span-6">
        <div class="row">
          <div>
            <label>Saldo poczƒÖtkowe (PLN)</label>
            <input id="P" type="number" step="0.01" value="" placeholder="np. 52237.35" />
          </div>
          <div>
            <label>Rata podstawowa (PLN)</label>
            <input id="PMT" type="number" step="0.01" value="" placeholder="np. 2347.14" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Data pierwszej raty</label>
            <input id="startDate" type="date" value="" />
          </div>
          <div>
            <label>Roczna stopa (%)</label>
            <input id="rYear" type="number" step="0.0001" value="" placeholder="np. 14.49" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Typ stopy</label>
            <select id="rateType">
              <option value="nominal">Nominalna (najczƒô≈õciej w banku)</option>
              <option value="effective">Efektywna</option>
            </select>
          </div>
          <div>
            <label>Miesiƒôczna stopa modelowa</label>
            <input id="monthlyRatePreview" type="text" disabled value="‚Äî" />
          </div>
        </div>

        <div class="mini-box" id="paymentCheckBox">
          <div class="line">Rata modelowa: ‚Äî</div>
          <div class="line">Wpisana rata: ‚Äî</div>
          <div class="line">R√≥≈ºnica: ‚Äî</div>
        </div>

        <div id="modeSection" style="margin-top:12px">
          <div class="row" id="modeRow">
            <div id="endDateWrap">
              <label>Data ostatniej raty <span class="muted">(wymagana dla trybu ‚Äûni≈ºsza rata‚Äù)</span></label>
              <input id="endDate" type="date" value="" />
            </div>
            <div id="modeWrap">
              <label>Tryb nadp≈Çaty</label>
              <select id="mode">
                <option value="shorten">Skr√≥cenie okresu</option>
                <option value="lower">Obni≈ºenie raty</option>
              </select>
            </div>
          </div>

          <p id="dateRangeHint" class="note hidden" style="margin:8px 0 0 0">Pozosta≈Çy okres: ‚Äî</p>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Nadp≈Çata miesiƒôczna (PLN)</label>
            <input id="extra" type="number" step="1" value="" placeholder="np. 500" />
          </div>
          <div>
            <label>Nadp≈Çata jednorazowa (PLN) <span class="muted">opcjonalnie</span></label>
            <input id="lump" type="number" step="1" value="" placeholder="np. 10000" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>MiesiƒÖc jednorazowej nadp≈Çaty</label>
            <input id="lumpMonth" type="number" step="1" value="1" />
            <p id="lumpMonthHint" class="note" style="margin-top:6px">‚Äî</p>
          </div>
          <div>
            <label>‚Äî</label>
            <input type="text" disabled value="Daty pojawiƒÖ siƒô w tabeli po '#'" />
          </div>
        </div>

        <div style="margin-top:14px;display:flex;gap:12px;flex-wrap:wrap">
          <button id="run" class="btn primary">Przelicz</button>
          <button id="reset" class="btn">Wyczy≈õƒá pola</button>
          <button id="exportCsv" class="btn" disabled>Eksportuj harmonogram CSV</button>
        </div>

        <p class="note" style="margin-top:10px">
          Tryb ‚Äûskr√≥cenie okresu‚Äù: rata podstawowa zostaje sta≈Ça, nadp≈Çaty skracajƒÖ czas sp≈Çaty.<br>
          Tryb ‚Äûobni≈ºenie raty‚Äù: okres pozostaje sta≈Çy, a rata jest przeliczana po ka≈ºdej nadp≈Çacie.
          <span class="warn">Symulacja bankowa mo≈ºe r√≥≈ºniƒá siƒô detalami (zaokrƒÖglenia, dni w miesiƒÖcu, moment przeliczenia, odsetki dzienne, dodatkowe koszty w racie).</span>
        </p>
      </div>

      <div class="card span-6">
        <div class="kpi">
          <div class="tile"><b>Miesiƒôcy do sp≈Çaty ‚Äì bazowo</b><div class="val" id="kpiBaseN">‚Äî</div></div>
          <div class="tile"><b>Miesiƒôcy do sp≈Çaty ‚Äì wynik</b><div class="val" id="kpiNewN">‚Äî</div></div>
          <div class="tile"><b>Skr√≥cenie okresu</b><div class="val" id="kpiSavedN">‚Äî</div></div>
          <div class="tile"><b>Odsetki ≈ÇƒÖcznie ‚Äì bazowo</b><div class="val" id="kpiBaseInt">‚Äî</div></div>
          <div class="tile"><b>Odsetki ≈ÇƒÖcznie ‚Äì wynik</b><div class="val" id="kpiNewInt">‚Äî</div></div>
          <div class="tile"><b>Oszczƒôdno≈õƒá na odsetkach</b><div class="val ok" id="kpiSavedInt">‚Äî</div></div>
          <div class="tile"><b>Tryb</b><div class="val" id="kpiMode" style="font-size:16px">‚Äî</div></div>
          <div class="tile"><b>Nowa, najbli≈ºsza rata (tryb ‚Äûni≈ºsza rata‚Äù)</b><div class="val" id="kpiFirstNewPmt" style="font-size:18px">‚Äî</div></div>
        </div>
      </div>

      <div class="card span-12">
        <h3 style="margin:0 0 12px">Harmonogram (wybrany wariant)</h3>
        <table id="tbl">
          <thead>
            <tr>
              <th># / Data</th>
              <th>Saldo start</th>
              <th>Odsetki</th>
              <th>Rata</th>
              <th>Nadp≈Çata</th>
              <th>Sp≈Çata kapita≈Çu</th>
              <th>Saldo koniec</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
'use strict';

function fmt(n){
  return (isNaN(n) ? '‚Äî' : n.toLocaleString('pl-PL',{minimumFractionDigits:2,maximumFractionDigits:2})) + ' PLN';
}
function fmtN(n){ return isFinite(n) ? Math.round(n) : '‚Äî'; }
function fmtPct(n){
  return isFinite(n) ? (n*100).toLocaleString('pl-PL',{minimumFractionDigits:4,maximumFractionDigits:4}) + '%' : '‚Äî';
}

function parseDateInput(id){
  const v = document.getElementById(id).value;
  return v ? new Date(v + 'T00:00:00') : null;
}

function monthsBetweenInclusive(startDate, endDate){
  if (!startDate || !endDate) return null;
  const y1 = startDate.getFullYear();
  const m1 = startDate.getMonth();
  const y2 = endDate.getFullYear();
  const m2 = endDate.getMonth();
  const diff = (y2 - y1) * 12 + (m2 - m1);
  if (diff < 0) throw new Error('Data ostatniej raty nie mo≈ºe byƒá wcze≈õniejsza ni≈º data pierwszej raty.');
  return diff + 1;
}

function calcMonthlyRateFromInput(yearRatePct, rateType){
  const annual = Number(yearRatePct) / 100;
  if (!isFinite(annual)) return NaN;
  if (annual < 0) return NaN;

  if (rateType === 'effective') {
    return Math.pow(1 + annual, 1/12) - 1;
  }
  // nominalna (domy≈õlnie): prosty podzia≈Ç przez 12
  return annual / 12;
}

function calcAnnuityPayment(P, r, n){
  if (n <= 0) return 0;
  if (r === 0) return P / n;
  return P * r / (1 - Math.pow(1 + r, -n));
}

function hasMinimumInputs(){
  const P = document.getElementById('P').value;
  const PMT = document.getElementById('PMT').value;
  const rYear = document.getElementById('rYear').value;
  const mode = document.getElementById('mode').value;
  const endDate = document.getElementById('endDate').value;
  if (String(P).trim() === '' || String(PMT).trim() === '' || String(rYear).trim() === '') return false;
  if (mode === 'lower' && String(endDate).trim() === '') return false;
  return true;
}

function amortizeShorten({P, PMT, r, extra=0, lump=0, lumpMonth=1, maxMonths=480}){
  let bal = Number(P);
  let m = 0, totalInt = 0;
  const rows = [];

  if (r < 0) throw new Error('Stopa procentowa nie mo≈ºe byƒá ujemna.');
  if (PMT <= 0) throw new Error('Rata musi byƒá wiƒôksza od 0.');

  while (bal > 0.005 && m < maxMonths){
    m++;
    const start = bal;
    const interest = bal * r;
    const extraLump = (m === Number(lumpMonth) ? Number(lump) : 0);

    const needPrincipalNoLump = Math.max(bal - extraLump, 0);
    const maxNeededNoLump = interest + needPrincipalNoLump;
    const desiredNoLump = PMT + extra;
    const paidNoLump = Math.min(desiredNoLump, maxNeededNoLump);

    if (paidNoLump <= interest + 1e-9){
      throw new Error('Rata za ma≈Ça wzglƒôdem oprocentowania. Zwiƒôksz ratƒô lub sprawd≈∫ stopƒô.');
    }

    const pmtPaid = Math.min(PMT, paidNoLump);
    const extraPaid = paidNoLump - pmtPaid;
    const principalNoLump = paidNoLump - interest;
    const endBal = Math.max(bal - principalNoLump - extraLump, 0);

    rows.push({ m, start, interest, pmt: pmtPaid, extra: extraPaid, extraLump, principal: principalNoLump, endBal });
    totalInt += interest;
    bal = endBal;
  }

  if (m >= maxMonths && bal > 0.005) throw new Error('Nie uda≈Ço siƒô sp≈Çaciƒá kredytu w limicie miesiƒôcy.');
  return {months:m, totalInterest:totalInt, rows};
}

function amortizeLowerPayment({P, PMT, r, remainingMonths, extra=0, lump=0, lumpMonth=1}){
  let bal = Number(P);
  let totalInt = 0;
  const rows = [];
  const nTotal = Number(remainingMonths);

  if (!Number.isFinite(nTotal) || nTotal <= 0) throw new Error('Nie uda≈Ço siƒô wyliczyƒá poprawnej liczby miesiƒôcy z dat.');
  if (r < 0) throw new Error('Stopa procentowa nie mo≈ºe byƒá ujemna.');
  if (PMT <= 0) throw new Error('Rata musi byƒá wiƒôksza od 0.');

  for (let m = 1; m <= nTotal; m++){
    if (bal <= 0.005) break;

    const nLeftThisMonth = nTotal - m + 1;
    const start = bal;
    const interest = bal * r;
    const extraLump = (m === Number(lumpMonth) ? Number(lump) : 0);

    const recalculatedPMT = calcAnnuityPayment(start, r, nLeftThisMonth);
    const pmtCandidate = Math.max(0, recalculatedPMT);

    const needPrincipalNoLump = Math.max(start - extraLump, 0);
    const maxNeededNoLump = interest + needPrincipalNoLump;

    const desiredNoLump = pmtCandidate + Number(extra || 0);
    const paidNoLump = Math.min(desiredNoLump, maxNeededNoLump);

    if (paidNoLump <= interest + 1e-9){
      throw new Error('Rata po przeliczeniu jest za ma≈Ça wzglƒôdem odsetek.');
    }

    const pmtPaid = Math.min(pmtCandidate, paidNoLump);
    const extraPaid = paidNoLump - pmtPaid;
    const principalNoLump = paidNoLump - interest;
    const endBal = Math.max(start - principalNoLump - extraLump, 0);

    rows.push({ m, start, interest, pmt: pmtPaid, extra: extraPaid, extraLump, principal: principalNoLump, endBal });

    totalInt += interest;
    bal = endBal;
  }

  if (bal > 0.01){
    throw new Error('Po zadanym okresie pozosta≈Ço saldo. Sprawd≈∫ dane wej≈õciowe (rata / stopa / daty).');
  }

  return {months: rows.length, totalInterest: totalInt, rows};
}

function formatDate(d){
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yy = d.getFullYear();
  return `${dd}.${mm}.${yy}`;
}
function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
function addMonthsKeepDay(date, add){
  const y = date.getFullYear();
  const m = date.getMonth();
  const d = date.getDate();
  const targetM = m + add;
  const targetY = y + Math.floor(targetM/12);
  const normM = ((targetM%12)+12)%12;
  const dim = daysInMonth(targetY, normM);
  return new Date(targetY, normM, Math.min(d, dim));
}

function renderTable(rows, startDate){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const d = startDate ? addMonthsKeepDay(startDate, r.m-1) : null;
    const label = startDate ? `${r.m} # ${formatDate(d)}` : String(r.m);
    const cells = [label, r.start, r.interest, r.pmt, (r.extra + r.extraLump), (r.principal + r.extraLump), r.endBal];

    cells.forEach((v,i)=>{
      const td = document.createElement('td');
      td.textContent = (i === 0) ? v : fmt(v);
      tr.appendChild(td);
    });

    tb.appendChild(tr);
  });
}

function toCSV(rows, startDate){
  const header = ['Okres','Data','Saldo_start','Odsetki','Rata','Nadp≈Çata','Sp≈Çata_kapita≈Çu','Saldo_koniec'];
  const body = rows.map(r=>{
    const d = startDate ? addMonthsKeepDay(startDate, r.m-1) : null;
    const dateStr = startDate ? formatDate(d) : '';
    return [
      r.m,
      dateStr,
      r.start.toFixed(2),
      r.interest.toFixed(2),
      r.pmt.toFixed(2),
      (r.extra + r.extraLump).toFixed(2),
      (r.principal + r.extraLump).toFixed(2),
      r.endBal.toFixed(2)
    ].join(',');
  });
  return [header.join(','), ...body].join('\n');
}

function getInputs(){
  const P = parseFloat(document.getElementById('P').value || '0');
  const PMT = parseFloat(document.getElementById('PMT').value || '0');

  const rYear = parseFloat(document.getElementById('rYear').value || '0');
  const rateType = document.getElementById('rateType').value;
  const r = calcMonthlyRateFromInput(rYear, rateType);

  const startDate = parseDateInput('startDate');
  const endDate = parseDateInput('endDate');

  const mode = document.getElementById('mode').value;
  const extra = parseFloat(document.getElementById('extra').value || '0');
  const lump = parseFloat(document.getElementById('lump').value || '0');
  const lumpMonth = parseInt(document.getElementById('lumpMonth').value || '1', 10);

  let remainingMonths = null;
  if (startDate && endDate) remainingMonths = monthsBetweenInclusive(startDate, endDate);

  return {P, PMT, rYear, rateType, r, startDate, endDate, remainingMonths, mode, extra, lump, lumpMonth};
}

function enableExport(rows, startDate){
  const btn = document.getElementById('exportCsv');
  btn.disabled = false;
  btn.onclick = () => {
    const csv = toCSV(rows, startDate);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'harmonogram_nadplat.csv';
    a.click();
    URL.revokeObjectURL(url);
  };
}

function updateModeUI(){
  const mode = document.getElementById('mode').value;
  const endDateWrap = document.getElementById('endDateWrap');
  const modeWrap = document.getElementById('modeWrap');
  const dateHint = document.getElementById('dateRangeHint');

  if (mode === 'lower'){
    endDateWrap.classList.remove('hidden');
    dateHint.classList.remove('hidden');
    modeWrap.style.gridColumn = '';
  } else {
    endDateWrap.classList.add('hidden');
    dateHint.classList.add('hidden');
    modeWrap.style.gridColumn = '1 / span 2';
  }

  updateDateRangeHint();
  updateLumpMonthHint();
  updatePaymentCheckBox();
}

function updateMonthlyRatePreview(){
  const rYearVal = parseFloat(document.getElementById('rYear').value || '');
  const rateType = document.getElementById('rateType').value;
  const monthly = calcMonthlyRateFromInput(rYearVal, rateType);

  const field = document.getElementById('monthlyRatePreview');
  if (!isFinite(monthly)) {
    field.value = '‚Äî';
    return;
  }
  field.value = fmtPct(monthly);
}

function updatePaymentCheckBox(){
  const box = document.getElementById('paymentCheckBox');
  const P = parseFloat(document.getElementById('P').value || '');
  const PMT = parseFloat(document.getElementById('PMT').value || '');
  const rYear = parseFloat(document.getElementById('rYear').value || '');
  const rateType = document.getElementById('rateType').value;
  const startDate = parseDateInput('startDate');
  const endDate = parseDateInput('endDate');
  const mode = document.getElementById('mode').value;
  const r = calcMonthlyRateFromInput(rYear, rateType);

  if (!isFinite(P) || !isFinite(PMT) || !isFinite(r) || P <= 0 || PMT <= 0 || r < 0) {
    box.innerHTML = '<div class="line">Rata modelowa: ‚Äî</div><div class="line">Wpisana rata: ‚Äî</div><div class="line">R√≥≈ºnica: ‚Äî</div>';
    return;
  }

  let nModel = null;

  if (mode === 'lower') {
    if (startDate && endDate) {
      try { nModel = monthsBetweenInclusive(startDate, endDate); } catch(_) {}
    }
  } else {
    // Dla trybu skr√≥cenia okresu wyliczamy modelowy okres z wpisanej raty (przybli≈ºenie)
    // n = -ln(1 - rP/PMT) / ln(1+r)
    if (r === 0) {
      nModel = Math.ceil(P / PMT);
    } else {
      const x = 1 - (r * P) / PMT;
      if (x > 0) {
        nModel = Math.ceil((-Math.log(x)) / Math.log(1 + r));
      }
    }
  }

  if (!isFinite(nModel) || nModel <= 0) {
    box.innerHTML = `
      <div class="line">Rata modelowa: ‚Äî</div>
      <div class="line">Wpisana rata: ${fmt(PMT)}</div>
      <div class="line warn">Uzupe≈Çnij dane, aby por√≥wnaƒá ratƒô modelowƒÖ.</div>
    `;
    return;
  }

  const modelPmt = calcAnnuityPayment(P, r, nModel);
  const diff = PMT - modelPmt;
  const absDiff = Math.abs(diff);

  let hint = '';
  if (absDiff < 1.5) {
    hint = '<span class="ok">Bardzo zbli≈ºona do modelu.</span>';
  } else if (absDiff < 10) {
    hint = '<span class="warn">Niewielka r√≥≈ºnica ‚Äì to czƒôste (zaokrƒÖglenia / odsetki dzienne / daty rat).</span>';
  } else {
    hint = '<span class="warn">Wiƒôksza r√≥≈ºnica ‚Äì to nadal mo≈ºe byƒá normalne w banku (odsetki dzienne, inne zasady naliczania, dodatkowe koszty w racie).</span>';
  }

  box.innerHTML = `
    <div class="line">Rata modelowa: <span class="ok">${fmt(modelPmt)}</span></div>
    <div class="line">Wpisana rata: ${fmt(PMT)}</div>
    <div class="line">R√≥≈ºnica: <span class="${diff >= 0 ? 'warn' : 'bad'}">${fmt(diff)}</span></div>
    <div class="line">${hint}</div>
  `;
}

function updateDateRangeHint(){
  const hint = document.getElementById('dateRangeHint');
  const mode = document.getElementById('mode').value;
  if (!hint) return;

  if (mode !== 'lower'){
    hint.innerHTML = 'Pozosta≈Çy okres: ‚Äî';
    return;
  }

  const startDate = parseDateInput('startDate');
  const endDate = parseDateInput('endDate');

  if (!startDate || !endDate){
    hint.innerHTML = 'Pozosta≈Çy okres: ‚Äî <span class="warn">(wymagany w trybie ‚Äûni≈ºsza rata‚Äù)</span>';
    return;
  }

  try {
    const months = monthsBetweenInclusive(startDate, endDate);
    const sameDay = startDate.getDate() === endDate.getDate();
    const sameDayNote = sameDay ? '' : ' <span class="warn">(r√≥≈ºne dni miesiƒÖca ‚Äî liczenie kalendarzowe)</span>';
    hint.innerHTML = `Pozosta≈Çy okres: <span class="ok">${months} mies.</span>${sameDayNote}`;
  } catch (e){
    hint.innerHTML = `<span class="bad">${e.message}</span>`;
  }
}

function updateLumpMonthHint(){
  const hint = document.getElementById('lumpMonthHint');
  const mode = document.getElementById('mode').value;
  const lumpVal = document.getElementById('lump').value;
  const lumpMonthRaw = document.getElementById('lumpMonth').value;
  const lumpMonth = parseInt(lumpMonthRaw || '0', 10);

  if (!hint) return;

  if (String(lumpVal).trim() === '' || Number(lumpVal) <= 0){
    hint.innerHTML = 'Jednorazowa nadp≈Çata jest opcjonalna.';
    return;
  }

  if (!Number.isInteger(lumpMonth) || lumpMonth < 1){
    hint.innerHTML = '<span class="bad">Podaj miesiƒÖc nadp≈Çaty jako liczbƒô ca≈ÇkowitƒÖ ‚â• 1.</span>';
    return;
  }

  if (mode === 'lower'){
    const startDate = parseDateInput('startDate');
    const endDate = parseDateInput('endDate');

    if (!startDate || !endDate){
      hint.innerHTML = '<span class="warn">Aby zwalidowaƒá miesiƒÖc nadp≈Çaty, uzupe≈Çnij datƒô pierwszej i ostatniej raty.</span>';
      return;
    }

    try {
      const months = monthsBetweenInclusive(startDate, endDate);
      if (lumpMonth > months){
        hint.innerHTML = `<span class="bad">MiesiƒÖc nadp≈Çaty (${lumpMonth}) jest poza zakresem: 1‚Äì${months}.</span>`;
      } else {
        const d = addMonthsKeepDay(startDate, lumpMonth - 1);
        hint.innerHTML = `Jednorazowa nadp≈Çata w miesiƒÖcu <span class="ok">${lumpMonth}</span> (${formatDate(d)}).`;
      }
    } catch (e){
      hint.innerHTML = `<span class="bad">${e.message}</span>`;
    }
    return;
  }

  hint.innerHTML = `Jednorazowa nadp≈Çata w miesiƒÖcu <span class="ok">${lumpMonth}</span>. <span class="muted">(maksymalny zakres zale≈ºy od d≈Çugo≈õci sp≈Çaty)</span>`;
}

function run(){
  if (!hasMinimumInputs()){
    alert('Uzupe≈Çnij przynajmniej: saldo poczƒÖtkowe, ratƒô podstawowƒÖ i rocznƒÖ stopƒô. Dla trybu ‚Äûni≈ºsza rata‚Äù podaj te≈º datƒô ostatniej raty.');
    return;
  }

  const {P, PMT, r, startDate, endDate, remainingMonths, mode, extra, lump, lumpMonth} = getInputs();

  if (!isFinite(r)) throw new Error('Podaj poprawnƒÖ rocznƒÖ stopƒô procentowƒÖ.');
  if (r < 0) throw new Error('Stopa procentowa nie mo≈ºe byƒá ujemna.');

  let base, result, modeLabel;

  if (mode === 'lower') {
    if (!startDate || !endDate) throw new Error('Dla trybu ‚Äûni≈ºsza rata‚Äù podaj datƒô pierwszej i ostatniej raty.');
    if (lump > 0 && (lumpMonth < 1 || lumpMonth > remainingMonths)) {
      throw new Error(`MiesiƒÖc jednorazowej nadp≈Çaty musi mie≈õciƒá siƒô w zakresie 1‚Äì${remainingMonths}.`);
    }

    base = amortizeLowerPayment({P, PMT, r, remainingMonths, extra:0, lump:0});
    result = amortizeLowerPayment({P, PMT, r, remainingMonths, extra, lump, lumpMonth});
    modeLabel = 'Obni≈ºenie raty';
  } else {
    if (lump > 0 && lumpMonth < 1) throw new Error('MiesiƒÖc jednorazowej nadp≈Çaty musi byƒá >= 1.');

    base = amortizeShorten({P, PMT, r, extra:0, lump:0});
    result = amortizeShorten({P, PMT, r, extra, lump, lumpMonth});
    modeLabel = 'Skr√≥cenie okresu';
  }

  document.getElementById('kpiBaseN').textContent = fmtN(base.months) + ' mies.';
  document.getElementById('kpiNewN').textContent  = fmtN(result.months) + ' mies.';
  document.getElementById('kpiSavedN').textContent = fmtN(base.months - result.months) + ' mies.';
  document.getElementById('kpiBaseInt').textContent = fmt(base.totalInterest);
  document.getElementById('kpiNewInt').textContent  = fmt(result.totalInterest);
  document.getElementById('kpiSavedInt').textContent= fmt(base.totalInterest - result.totalInterest);
  document.getElementById('kpiMode').textContent = modeLabel;

  if (mode === 'lower' && result.rows.length > 0) {
    document.getElementById('kpiFirstNewPmt').textContent = fmt(result.rows[0].pmt);
  } else {
    document.getElementById('kpiFirstNewPmt').textContent = '‚Äî';
  }

  renderTable(result.rows, startDate);
  enableExport(result.rows, startDate);

  updateDateRangeHint();
  updateLumpMonthHint();
  updatePaymentCheckBox();
}

function clearAll(){
  ['P','PMT','startDate','endDate','rYear','extra','lump'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('lumpMonth').value = '1';
  document.getElementById('mode').value = 'shorten';
  document.getElementById('rateType').value = 'nominal';
  document.getElementById('monthlyRatePreview').value = '‚Äî';

  ['kpiBaseN','kpiNewN','kpiSavedN','kpiBaseInt','kpiNewInt','kpiSavedInt','kpiMode','kpiFirstNewPmt']
    .forEach(id => document.getElementById(id).textContent = '‚Äî');

  document.querySelector('#tbl tbody').innerHTML = '';
  const btn = document.getElementById('exportCsv');
  btn.disabled = true;
  btn.onclick = null;

  updateModeUI();
  updateDateRangeHint();
  updateLumpMonthHint();
  updatePaymentCheckBox();
}

document.getElementById('run').addEventListener('click', ()=>{ try{ run(); } catch(e){ alert(e.message); } });
document.getElementById('reset').addEventListener('click', clearAll);

document.getElementById('mode').addEventListener('change', updateModeUI);
document.getElementById('rateType').addEventListener('change', () => { updateMonthlyRatePreview(); updatePaymentCheckBox(); });
document.getElementById('rYear').addEventListener('input', () => { updateMonthlyRatePreview(); updatePaymentCheckBox(); });
document.getElementById('P').addEventListener('input', updatePaymentCheckBox);
document.getElementById('PMT').addEventListener('input', updatePaymentCheckBox);

document.getElementById('startDate').addEventListener('change', () => { updateDateRangeHint(); updateLumpMonthHint(); updatePaymentCheckBox(); });
document.getElementById('endDate').addEventListener('change', () => { updateDateRangeHint(); updateLumpMonthHint(); updatePaymentCheckBox(); });

document.getElementById('lumpMonth').addEventListener('input', updateLumpMonthHint);
document.getElementById('lump').addEventListener('input', updateLumpMonthHint);

// start
updateMonthlyRatePreview();
updateModeUI();
updateLumpMonthHint();
updatePaymentCheckBox();
</script>
</body>
</html>
