<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalkulator nadpÅ‚at kredytu</title>
  <style>
    :root { --bg:#0b0c10; --card:#14161a; --muted:#8892a6; --fg:#e9eef7; --accent:#7aa2f7; --ok:#67e8a5; --warn:#f6c84f; --bad:#ff6b6b; }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--fg);}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 18px}
    p.help{color:var(--muted);margin-top:4px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.07);border-radius:16px;padding:16px}
    .span-6{grid-column:span 6}
    .span-12{grid-column:span 12}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f1115;color:var(--fg)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#11141a;color:var(--fg);cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:#0b1220;font-weight:600}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .kpi{display:flex;gap:16px;flex-wrap:wrap}
    .kpi .tile{flex:1 1 220px;background:#0f1217;border:1px dashed rgba(255,255,255,.12);border-radius:14px;padding:14px}
    .kpi .tile b{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .kpi .tile .val{font-size:22px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:right}
    th{color:var(--muted);font-weight:600}
    td:first-child, th:first-child{text-align:center}
    .muted{color:var(--muted)}
    .note{font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .bad{color:var(--bad)}
    .hidden{display:none !important;}
    @media (max-width:900px){.span-6{grid-column:span 12}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“‰ Kalkulator nadpÅ‚at kredytu</h1>
    <p class="help">
      Wpisz parametry oraz nadpÅ‚aty. Zobaczysz, o ile szybciej spÅ‚acisz kredyt i ile odsetek zaoszczÄ™dzisz.
      <span class="muted">To wersja publiczna â€“ pola startujÄ… puste.</span>
    </p>

    <div class="grid">
      <div class="card span-6">
        <div class="row">
          <div>
            <label>Saldo poczÄ…tkowe (PLN)</label>
            <input id="P" type="number" step="0.01" value="" placeholder="np. 52237.35" />
          </div>
          <div>
            <label>Rata podstawowa (PLN)</label>
            <input id="PMT" type="number" step="0.01" value="" placeholder="np. 2347.14" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Data pierwszej raty</label>
            <input id="startDate" type="date" value="" />
          </div>
          <div>
            <label>Roczna stopa (%) <span class="muted">(nominalna)</span></label>
            <input id="rYear" type="number" step="0.0001" value="" placeholder="np. 14.49" />
          </div>
        </div>

        <div id="modeSection" style="margin-top:12px">
          <div class="row" id="modeRow">
            <div id="endDateWrap">
              <label>Data ostatniej raty <span class="muted">(wymagana dla trybu â€niÅ¼sza rataâ€)</span></label>
              <input id="endDate" type="date" value="" />
            </div>
            <div id="modeWrap">
              <label>Tryb nadpÅ‚aty</label>
              <select id="mode">
                <option value="shorten">SkrÃ³cenie okresu</option>
                <option value="lower">ObniÅ¼enie raty</option>
              </select>
            </div>
          </div>

          <p id="dateRangeHint" class="note hidden" style="margin:8px 0 0 0">PozostaÅ‚y okres: â€”</p>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>NadpÅ‚ata miesiÄ™czna (PLN)</label>
            <input id="extra" type="number" step="1" value="" placeholder="np. 500" />
          </div>
          <div>
            <label>NadpÅ‚ata jednorazowa (PLN) <span class="muted">opcjonalnie</span></label>
            <input id="lump" type="number" step="1" value="" placeholder="np. 10000" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>MiesiÄ…c jednorazowej nadpÅ‚aty</label>
            <input id="lumpMonth" type="number" step="1" value="1" />
            <p id="lumpMonthHint" class="note" style="margin-top:6px">â€”</p>
          </div>
          <div>
            <label>â€”</label>
            <input type="text" disabled value="Daty pojawiÄ… siÄ™ w tabeli po '#'" />
          </div>
        </div>

        <div style="margin-top:14px;display:flex;gap:12px;flex-wrap:wrap">
          <button id="run" class="btn primary">Przelicz</button>
          <button id="reset" class="btn">WyczyÅ›Ä‡ pola</button>
          <button id="exportCsv" class="btn" disabled>Eksportuj harmonogram CSV</button>
        </div>

        <p class="note" style="margin-top:10px">
          Tryb â€skrÃ³cenie okresuâ€: rata podstawowa zostaje staÅ‚a, nadpÅ‚aty skracajÄ… czas spÅ‚aty.<br>
          Tryb â€obniÅ¼enie ratyâ€: najbliÅ¼sza rata pozostaje jak wpisana, a kolejne raty sÄ… przeliczane przy zachowaniu okresu.
          <span class="warn">To podglÄ…d/symulacja â€” bank moÅ¼e liczyÄ‡ nieco inaczej (zaokrÄ…glenia, dni w miesiÄ…cu, odsetki dzienne, moment przeliczenia).</span>
        </p>
      </div>

      <div class="card span-6">
        <div class="kpi">
          <div class="tile"><b>MiesiÄ™cy do spÅ‚aty â€“ bazowo</b><div class="val" id="kpiBaseN">â€”</div></div>
          <div class="tile"><b>MiesiÄ™cy do spÅ‚aty â€“ wynik</b><div class="val" id="kpiNewN">â€”</div></div>
          <div class="tile"><b>SkrÃ³cenie okresu</b><div class="val" id="kpiSavedN">â€”</div></div>
          <div class="tile"><b>Odsetki Å‚Ä…cznie â€“ bazowo</b><div class="val" id="kpiBaseInt">â€”</div></div>
          <div class="tile"><b>Odsetki Å‚Ä…cznie â€“ wynik</b><div class="val" id="kpiNewInt">â€”</div></div>
          <div class="tile"><b>OszczÄ™dnoÅ›Ä‡ na odsetkach</b><div class="val ok" id="kpiSavedInt">â€”</div></div>
          <div class="tile"><b>Tryb</b><div class="val" id="kpiMode" style="font-size:16px">â€”</div></div>
          <div class="tile"><b>Nowa, najbliÅ¼sza rata (tryb â€niÅ¼sza rataâ€)</b><div class="val" id="kpiFirstNewPmt" style="font-size:18px">â€”</div></div>
        </div>
      </div>

      <div class="card span-12">
        <h3 style="margin:0 0 12px">Harmonogram (wybrany wariant)</h3>
        <table id="tbl">
          <thead>
            <tr>
              <th># / Data</th>
              <th>Saldo start</th>
              <th>Odsetki</th>
              <th>Rata</th>
              <th>NadpÅ‚ata</th>
              <th>SpÅ‚ata kapitaÅ‚u</th>
              <th>Saldo koniec</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
'use strict';

function fmt(n){
  return (isNaN(n) ? 'â€”' : n.toLocaleString('pl-PL',{minimumFractionDigits:2,maximumFractionDigits:2})) + ' PLN';
}
function fmtN(n){ return isFinite(n) ? Math.round(n) : 'â€”'; }

function parseDateInput(id){
  const v = document.getElementById(id).value;
  return v ? new Date(v + 'T00:00:00') : null;
}

function monthsBetweenInclusive(startDate, endDate){
  if (!startDate || !endDate) return null;
  const y1 = startDate.getFullYear();
  const m1 = startDate.getMonth();
  const y2 = endDate.getFullYear();
  const m2 = endDate.getMonth();
  const diff = (y2 - y1) * 12 + (m2 - m1);
  if (diff < 0) throw new Error('Data ostatniej raty nie moÅ¼e byÄ‡ wczeÅ›niejsza niÅ¼ data pierwszej raty.');
  return diff + 1;
}

// Roczna nominalna -> miesiÄ™czna (uproszczenie modelowe)
function calcMonthlyRateFromNominal(yearRatePct){
  const annual = Number(yearRatePct) / 100;
  if (!isFinite(annual) || annual < 0) return NaN;
  return annual / 12;
}

function calcAnnuityPayment(P, r, n){
  if (n <= 0) return 0;
  if (r === 0) return P / n;
  return P * r / (1 - Math.pow(1 + r, -n));
}

function hasMinimumInputs(){
  const P = document.getElementById('P').value;
  const PMT = document.getElementById('PMT').value;
  const rYear = document.getElementById('rYear').value;
  const mode = document.getElementById('mode').value;
  const endDate = document.getElementById('endDate').value;

  if (String(P).trim() === '' || String(PMT).trim() === '' || String(rYear).trim() === '') return false;
  if (mode === 'lower' && String(endDate).trim() === '') return false;
  return true;
}

function amortizeShorten({P, PMT, r, extra=0, lump=0, lumpMonth=1, maxMonths=480}){
  let bal = Number(P);
  let m = 0, totalInt = 0;
  const rows = [];

  if (r < 0) throw new Error('Stopa procentowa nie moÅ¼e byÄ‡ ujemna.');
  if (PMT <= 0) throw new Error('Rata musi byÄ‡ wiÄ™ksza od 0.');

  while (bal > 0.005 && m < maxMonths){
    m++;
    const start = bal;
    const interest = bal * r;
    const extraLump = (m === Number(lumpMonth) ? Number(lump) : 0);

    const needPrincipalNoLump = Math.max(bal - extraLump, 0);
    const maxNeededNoLump = interest + needPrincipalNoLump;
    const desiredNoLump = PMT + extra;
    const paidNoLump = Math.min(desiredNoLump, maxNeededNoLump);

    if (paidNoLump <= interest + 1e-9){
      throw new Error('Rata za maÅ‚a wzglÄ™dem oprocentowania. ZwiÄ™ksz ratÄ™ lub sprawdÅº stopÄ™.');
    }

    const pmtPaid = Math.min(PMT, paidNoLump);
    const extraPaid = paidNoLump - pmtPaid;
    const principalNoLump = paidNoLump - interest;
    const endBal = Math.max(bal - principalNoLump - extraLump, 0);

    rows.push({ m, start, interest, pmt: pmtPaid, extra: extraPaid, extraLump, principal: principalNoLump, endBal });
    totalInt += interest;
    bal = endBal;
  }

  if (m >= maxMonths && bal > 0.005) throw new Error('Nie udaÅ‚o siÄ™ spÅ‚aciÄ‡ kredytu w limicie miesiÄ™cy.');
  return {months:m, totalInterest:totalInt, rows};
}

// Tryb "obniÅ¼enie raty":
// - rata w 1. miesiÄ…cu zostaje taka jak wpisana przez uÅ¼ytkownika (PMT)
// - od 2. miesiÄ…ca rata jest przeliczana
function amortizeLowerPayment({P, PMT, r, remainingMonths, extra=0, lump=0, lumpMonth=1}){
  let bal = Number(P);
  let totalInt = 0;
  const rows = [];
  const nTotal = Number(remainingMonths);

  if (!Number.isFinite(nTotal) || nTotal <= 0) throw new Error('Nie udaÅ‚o siÄ™ wyliczyÄ‡ poprawnej liczby miesiÄ™cy z dat.');
  if (r < 0) throw new Error('Stopa procentowa nie moÅ¼e byÄ‡ ujemna.');
  if (PMT <= 0) throw new Error('Rata musi byÄ‡ wiÄ™ksza od 0.');

  for (let m = 1; m <= nTotal; m++){
    if (bal <= 0.005) break;

    const nLeftThisMonth = nTotal - m + 1;
    const start = bal;
    const interest = bal * r;
    const extraLump = (m === Number(lumpMonth) ? Number(lump) : 0);

    // NajbliÅ¼sza rata = wpisana przez uÅ¼ytkownika. Kolejne raty przeliczamy.
    const recalculatedPMT = calcAnnuityPayment(start, r, nLeftThisMonth);
    const pmtCandidate = (m === 1) ? Number(PMT) : Math.max(0, recalculatedPMT);

    const needPrincipalNoLump = Math.max(start - extraLump, 0);
    const maxNeededNoLump = interest + needPrincipalNoLump;

    const desiredNoLump = pmtCandidate + Number(extra || 0);
    const paidNoLump = Math.min(desiredNoLump, maxNeededNoLump);

    if (paidNoLump <= interest + 1e-9){
      throw new Error('Rata po przeliczeniu jest za maÅ‚a wzglÄ™dem odsetek.');
    }

    const pmtPaid = Math.min(pmtCandidate, paidNoLump);
    const extraPaid = paidNoLump - pmtPaid;
    const principalNoLump = paidNoLump - interest;
    const endBal = Math.max(start - principalNoLump - extraLump, 0);

    rows.push({ m, start, interest, pmt: pmtPaid, extra: extraPaid, extraLump, principal: principalNoLump, endBal });

    totalInt += interest;
    bal = endBal;
  }

  if (bal > 0.01){
    throw new Error('Po zadanym okresie pozostaÅ‚o saldo. SprawdÅº dane wejÅ›ciowe (rata / stopa / daty).');
  }

  return {months: rows.length, totalInterest: totalInt, rows};
}

function formatDate(d){
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yy = d.getFullYear();
  return `${dd}.${mm}.${yy}`;
}
function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
function addMonthsKeepDay(date, add){
  const y = date.getFullYear();
  const m = date.getMonth();
  const d = date.getDate();
  const targetM = m + add;
  const targetY = y + Math.floor(targetM/12);
  const normM = ((targetM%12)+12)%12;
  const dim = daysInMonth(targetY, normM);
  return new Date(targetY, normM, Math.min(d, dim));
}

function renderTable(rows, startDate){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const d = startDate ? addMonthsKeepDay(startDate, r.m-1) : null;
    const label = startDate ? `${r.m} # ${formatDate(d)}` : String(r.m);
    const cells = [label, r.start, r.interest, r.pmt, (r.extra + r.extraLump), (r.principal + r.extraLump), r.endBal];

    cells.forEach((v,i)=>{
      const td = document.createElement('td');
      td.textContent = (i === 0) ? v : fmt(v);
      tr.appendChild(td);
    });

    tb.appendChild(tr);
  });
}

function toCSV(rows, startDate){
  const header = ['Okres','Data','Saldo_start','Odsetki','Rata','NadpÅ‚ata','SpÅ‚ata_kapitaÅ‚u','Saldo_koniec'];
  const body = rows.map(r=>{
    const d = startDate ? addMonthsKeepDay(startDate, r.m-1) : null;
    const dateStr = startDate ? formatDate(d) : '';
    return [
      r.m,
      dateStr,
      r.start.toFixed(2),
      r.interest.toFixed(2),
      r.pmt.toFixed(2),
      (r.extra + r.extraLump).toFixed(2),
      (r.principal + r.extraLump).toFixed(2),
      r.endBal.toFixed(2)
    ].join(',');
  });
  return [header.join(','), ...body].join('\n');
}

function getInputs(){
  const P = parseFloat(document.getElementById('P').value || '0');
  const PMT = parseFloat(document.getElementById('PMT').value || '0');

  const rYear = parseFloat(document.getElementById('rYear').value || '0');
  const r = calcMonthlyRateFromNominal(rYear);

  const startDate = parseDateInput('startDate');
  const endDate = parseDateInput('endDate');

  const mode = document.getElementById('mode').value;
  const extra = parseFloat(document.getElementById('extra').value || '0');
  const lump = parseFloat(document.getElementById('lump').value || '0');
  const lumpMonth = parseInt(document.getElementById('lumpMonth').value || '1', 10);

  let remainingMonths = null;
  if (startDate && endDate) remainingMonths = monthsBetweenInclusive(startDate, endDate);

  return {P, PMT, rYear, r, startDate, endDate, remainingMonths, mode, extra, lump, lumpMonth};
}

function enableExport(rows, startDate){
  const btn = document.getElementById('exportCsv');
  btn.disabled = false;
  btn.onclick = () => {
    const csv = toCSV(rows, startDate);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'harmonogram_nadplat.csv';
    a.click();
    URL.revokeObjectURL(url);
  };
}

function updateModeUI(){
  const mode = document.getElementById('mode').value;
  const endDateWrap = document.getElementById('endDateWrap');
  const modeWrap = document.getElementById('modeWrap');
  const dateHint = document.getElementById('dateRangeHint');

  if (mode === 'lower'){
    endDateWrap.classList.remove('hidden');
    dateHint.classList.remove('hidden');
    modeWrap.style.gridColumn = '';
  } else {
    endDateWrap.classList.add('hidden');
    dateHint.classList.add('hidden');
    modeWrap.style.gridColumn = '1 / span 2';
  }

  updateDateRangeHint();
  updateLumpMonthHint();
}

function updateDateRangeHint(){
  const hint = document.getElementById('dateRangeHint');
  const mode = document.getElementById('mode').value;
  if (!hint) return;

  if (mode !== 'lower'){
    hint.innerHTML = 'PozostaÅ‚y okres: â€”';
    return;
  }

  const startDate = parseDateInput('startDate');
  const endDate = parseDateInput('endDate');

  if (!startDate || !endDate){
    hint.innerHTML = 'PozostaÅ‚y okres: â€” <span class="warn">(wymagany w trybie â€niÅ¼sza rataâ€)</span>';
    return;
  }

  try {
    const months = monthsBetweenInclusive(startDate, endDate);
    const sameDay = startDate.getDate() === endDate.getDate();
    const sameDayNote = sameDay ? '' : ' <span class="warn">(rÃ³Å¼ne dni miesiÄ…ca â€” liczenie kalendarzowe)</span>';
    hint.innerHTML = `PozostaÅ‚y okres: <span class="ok">${months} mies.</span>${sameDayNote}`;
  } catch (e){
    hint.innerHTML = `<span class="bad">${e.message}</span>`;
  }
}

function updateLumpMonthHint(){
  const hint = document.getElementById('lumpMonthHint');
  const mode = document.getElementById('mode').value;
  const lumpVal = document.getElementById('lump').value;
  const lumpMonthRaw = document.getElementById('lumpMonth').value;
  const lumpMonth = parseInt(lumpMonthRaw || '0', 10);

  if (!hint) return;

  if (String(lumpVal).trim() === '' || Number(lumpVal) <= 0){
    hint.innerHTML = 'Jednorazowa nadpÅ‚ata jest opcjonalna.';
    return;
  }

  if (!Number.isInteger(lumpMonth) || lumpMonth < 1){
    hint.innerHTML = '<span class="bad">Podaj miesiÄ…c nadpÅ‚aty jako liczbÄ™ caÅ‚kowitÄ… â‰¥ 1.</span>';
    return;
  }

  if (mode === 'lower'){
    const startDate = parseDateInput('startDate');
    const endDate = parseDateInput('endDate');

    if (!startDate || !endDate){
      hint.innerHTML = '<span class="warn">Aby zwalidowaÄ‡ miesiÄ…c nadpÅ‚aty, uzupeÅ‚nij datÄ™ pierwszej i ostatniej raty.</span>';
      return;
    }

    try {
      const months = monthsBetweenInclusive(startDate, endDate);
      if (lumpMonth > months){
        hint.innerHTML = `<span class="bad">MiesiÄ…c nadpÅ‚aty (${lumpMonth}) jest poza zakresem: 1â€“${months}.</span>`;
      } else {
        const d = addMonthsKeepDay(startDate, lumpMonth - 1);
        hint.innerHTML = `Jednorazowa nadpÅ‚ata w miesiÄ…cu <span class="ok">${lumpMonth}</span> (${formatDate(d)}).`;
      }
    } catch (e){
      hint.innerHTML = `<span class="bad">${e.message}</span>`;
    }
    return;
  }

  hint.innerHTML = `Jednorazowa nadpÅ‚ata w miesiÄ…cu <span class="ok">${lumpMonth}</span>. <span class="muted">(maksymalny zakres zaleÅ¼y od dÅ‚ugoÅ›ci spÅ‚aty)</span>`;
}

function run(){
  if (!hasMinimumInputs()){
    alert('UzupeÅ‚nij przynajmniej: saldo poczÄ…tkowe, ratÄ™ podstawowÄ… i rocznÄ… stopÄ™. Dla trybu â€niÅ¼sza rataâ€ podaj teÅ¼ datÄ™ ostatniej raty.');
    return;
  }

  const {P, PMT, r, startDate, endDate, remainingMonths, mode, extra, lump, lumpMonth} = getInputs();

  if (!isFinite(r)) throw new Error('Podaj poprawnÄ… rocznÄ… stopÄ™ procentowÄ….');
  if (r < 0) throw new Error('Stopa procentowa nie moÅ¼e byÄ‡ ujemna.');

  let base, result, modeLabel;

  if (mode === 'lower') {
    if (!startDate || !endDate) throw new Error('Dla trybu â€niÅ¼sza rataâ€ podaj datÄ™ pierwszej i ostatniej raty.');
    if (lump > 0 && (lumpMonth < 1 || lumpMonth > remainingMonths)) {
      throw new Error(`MiesiÄ…c jednorazowej nadpÅ‚aty musi mieÅ›ciÄ‡ siÄ™ w zakresie 1â€“${remainingMonths}.`);
    }

    base = amortizeLowerPayment({P, PMT, r, remainingMonths, extra:0, lump:0});
    result = amortizeLowerPayment({P, PMT, r, remainingMonths, extra, lump, lumpMonth});
    modeLabel = 'ObniÅ¼enie raty';
  } else {
    if (lump > 0 && lumpMonth < 1) throw new Error('MiesiÄ…c jednorazowej nadpÅ‚aty musi byÄ‡ >= 1.');

    base = amortizeShorten({P, PMT, r, extra:0, lump:0});
    result = amortizeShorten({P, PMT, r, extra, lump, lumpMonth});
    modeLabel = 'SkrÃ³cenie okresu';
  }

  document.getElementById('kpiBaseN').textContent = fmtN(base.months) + ' mies.';
  document.getElementById('kpiNewN').textContent  = fmtN(result.months) + ' mies.';
  document.getElementById('kpiSavedN').textContent = fmtN(base.months - result.months) + ' mies.';
  document.getElementById('kpiBaseInt').textContent = fmt(base.totalInterest);
  document.getElementById('kpiNewInt').textContent  = fmt(result.totalInterest);
  document.getElementById('kpiSavedInt').textContent= fmt(base.totalInterest - result.totalInterest);
  document.getElementById('kpiMode').textContent = modeLabel;

  if (mode === 'lower' && result.rows.length > 0) {
    document.getElementById('kpiFirstNewPmt').textContent = fmt(result.rows[0].pmt);
  } else {
    document.getElementById('kpiFirstNewPmt').textContent = 'â€”';
  }

  renderTable(result.rows, startDate);
  enableExport(result.rows, startDate);

  updateDateRangeHint();
  updateLumpMonthHint();
}

function clearAll(){
  ['P','PMT','startDate','endDate','rYear','extra','lump'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('lumpMonth').value = '1';
  document.getElementById('mode').value = 'shorten';

  ['kpiBaseN','kpiNewN','kpiSavedN','kpiBaseInt','kpiNewInt','kpiSavedInt','kpiMode','kpiFirstNewPmt']
    .forEach(id => document.getElementById(id).textContent = 'â€”');

  document.querySelector('#tbl tbody').innerHTML = '';
  const btn = document.getElementById('exportCsv');
  btn.disabled = true;
  btn.onclick = null;

  updateModeUI();
  updateDateRangeHint();
  updateLumpMonthHint();
}

document.getElementById('run').addEventListener('click', ()=>{ try{ run(); } catch(e){ alert(e.message); } });
document.getElementById('reset').addEventListener('click', clearAll);

document.getElementById('mode').addEventListener('change', updateModeUI);
document.getElementById('startDate').addEventListener('change', () => { updateDateRangeHint(); updateLumpMonthHint(); });
document.getElementById('endDate').addEventListener('change', () => { updateDateRangeHint(); updateLumpMonthHint(); });
document.getElementById('lumpMonth').addEventListener('input', updateLumpMonthHint);
document.getElementById('lump').addEventListener('input', updateLumpMonthHint);

// start
updateModeUI();
updateLumpMonthHint();
</script>
</body>
</html>
